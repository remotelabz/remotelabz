{% extends 'dashboard.base.html.twig' %}

{% block breadcrumbs %}
    {%- set breadcrumbs = breadcrumbs|merge({ 'Services': path('services') }) -%}
    {{ parent() }}
{% endblock %}

{% block sidebar %}
    {% set category = 'services' %}
    {{ parent() }}
{% endblock %}

{% block wrapper %}
<div class="content-title">
    <div class="content-title-infos">
        <h1>Local Services</h1>
    </div>
</div>
<div class="content-body">
    <div class="row">
        <div class="col">
            <div class="card">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw600">Messaging service
                            {% if serviceStatus['remotelabz'] %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                            {% else %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                            {% endif %}
                            </span>
                            <div>
                            {% if serviceStatus['remotelabz'] %}
                                <a href="{{ path('stop_service', {'service': 'remotelabz'}) }}" class="btn btn-danger">Stop</a>
                            {% else %}
                                <a href="{{ path('start_service', {'service': 'remotelabz'}) }}" class="btn btn-success">Start</a>
                            {% endif %}
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw600">Proxy service
                            {% if serviceStatus['remotelabz-proxy'] %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                            {% else %}
                            <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                            {% endif %}<br/>
                            <i class="fa fa-info-circle text-info"></i> {{ 'Creation of all proxy route to each device'|trans }}
                            </span>
                            
                            <div class="float-right">
                            {% if serviceStatus['remotelabz-proxy'] %}
                                <a href="{{ path('stop_service', {'service': 'remotelabz-proxy'}) }}" class="btn btn-danger">Stop</a>
                            {% else %}
                                <a href="{{ path('start_service', {'service': 'remotelabz-proxy'}) }}" class="btn btn-success">Start</a>
                            {% endif %}
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw600">Router service
                            {% if serviceStatus['router'] %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                            {% else %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                            {% endif %}<br/>
                            <i class="fa fa-info-circle text-info"></i> {{ 'Creation of all routes to each laboratory'|trans }}
                            </span>
                            <div class="float-right">
                                <a href="{{ path('start_service', {'service': 'router'}) }}" class="btn btn-danger">Restart</a>
                            </div>
                        </div>
                    </li>
                </ul>
              </div>
        </div>
    </div>
</div>

<div class="content-title">
    <div class="content-title-infos">
        <h1>System Checks</h1>
    </div>
</div>
<div class="content-body">
    <div class="row">
        <div class="col">
            <div class="card">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw600">SSH Connection Status
                            {% if serviceStatus['ssh-connection-check']['overall_status'] is defined %}
                                {% if serviceStatus['ssh-connection-check']['overall_status'] %}
                                    <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                                {% else %}
                                    <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: orange"></i>
                                {% endif %}
                            {% else %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                            {% endif %}<br/>
                            <i class="fa fa-info-circle text-info"></i> {{ 'SSH connectivity to all workers'|trans }}
                            {% if serviceStatus['ssh-connection-check'] is defined and serviceStatus['ssh-connection-check'] is iterable %}
                                <br/><small class="text-muted">
                                {% for ip, status in serviceStatus['ssh-connection-check'] %}
                                    {% if ip != 'overall_status' %}
                                        {{ ip }}: 
                                        {% if status.status %}
                                            <span class="text-success">✓ {{ status.method }}</span>
                                        {% else %}
                                            <span class="text-danger">✗ {{ status.error }}</span>
                                        {% endif %}
                                        {% if not loop.last %} | {% endif %}
                                    {% endif %}
                                {% endfor %}
                                </small>
                            {% endif %}
                            </span>
                            <div class="float-right">
                                <a href="{{ path('check_service', {'service': 'ssh-connection-check'}) }}" class="btn btn-primary">Check</a>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw600">Certificate Status
                            {% if serviceStatus['certificate-check']['overall_status'] is defined %}
                                {% if serviceStatus['certificate-check']['overall_status'] %}
                                    <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                                {% else %}
                                    <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                                {% endif %}
                            {% else %}
                                <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                            {% endif %}<br/>
                            <i class="fa fa-info-circle text-info"></i> {{ 'SSL/TLS certificates validity'|trans }}
                            {% if serviceStatus['certificate-check']['certificates'] is defined %}
                                <br/><small class="text-muted">
                                {% for key, cert in serviceStatus['certificate-check']['certificates'] %}
                                    {{ cert.name }}: 
                                    {% if cert.valid %}
                                        {% if cert.warning is defined and cert.warning %}
                                            <span class="text-warning">⚠ {{ cert.days_remaining }} days</span>
                                        {% else %}
                                            <span class="text-success">✓ {% if cert.days_remaining is defined %}{{ cert.days_remaining }} days{% endif %}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-danger">✗ {{ cert.error }}</span>
                                    {% endif %}
                                    {% if not loop.last %}<br/>{% endif %}
                                {% endfor %}
                                </small>
                            {% endif %}
                            </span>
                            <div class="float-right">
                                <a href="{{ path('check_service', {'service': 'certificate-check'}) }}" class="btn btn-primary">Check</a>
                            </div>
                        </div>
                    </li>
                </ul>
              </div>
        </div>
    </div>
</div>

<div class="content-title">
    <div class="content-title-infos">
        <h1>Remote Services</h1>
    </div>
</div>
<div class="content-body">
    <div class="row">
        <div class="col">
            <div class="card">
                <ul class="list-group list-group-flush">
                
                {% if serviceStatus['remotelabz-worker'] is defined %}

                    {% for key, status in serviceStatus['remotelabz-worker'] %}
                        <li class="list-group-item">
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="fw600">Worker Service: {{key}}
                                {% if status is same as(true) %}
                                        <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: green"></i>
                                {% elseif status is same as(false) %}
                                        <i aria-hidden="true" data-hidden="true" class="fa fa-circle" style="color: rgb(255, 0, 0)"></i>
                                {% elseif status is same as('error') %}
                                        Not available
                                {% endif %}<br/>
                                <i class="fa fa-info-circle text-info"></i> {{ 'Start all labs'|trans }}
                                </span>              
                            
                                <div class="float-right">
                                {% if status is same as(true) %}
                                    <a href="{{ path('stop_service', {'service': 'remotelabz-worker','ip':key }) }}" class="btn btn-danger">Stop</a>
                                {% elseif status is same as(false) %}
                                    <a href="{{ path('start_service', {'service': 'remotelabz-worker','ip':key}) }}" class="btn btn-success">Start</a>
                                {% else %}
                                    Not available
                                {% endif %}
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                {% else %}
                <li class="list-group-item">None</li>
                {% endif %}
                </ul>
              </div>
        </div>
    </div>
</div>
{% endblock %}