{% extends 'dashboard.base.html.twig' %}

{% block breadcrumbs %}
    {% set breadcrumbs = breadcrumbs|merge({ 'New': path('app_iso_new'),'ISO': path('app_iso_index') }) %}
    {{ parent() }}
{% endblock %}

{% block sidebar %}
    {% set category = 'isos' %}
    {{ parent() }}
{% endblock %}

{% block wrapper %}
    <div class="content-title">
        <div class="content-title-infos">
            <h1>{{ 'New ISO'|trans }}</h1>
            <p class="text-muted">{{ 'Create a new ISO file entry by uploading a file or providing a URL'|trans }}</p>
        </div>
        <div class="content-title-actions">
            <a href="{{ path('app_iso_index') }}" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i> {{ 'Back'|trans }}
            </a>
        </div>
    </div>

    <div class="content-body">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fa fa-compact-disc me-2"></i> {{ 'ISO Configuration'|trans }}
                        </h5>
                    </div>
                    <div class="card-body">
                        {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': true}}) }}
                        
                        <!-- Champ caché pour stocker le nom du fichier uploadé -->
                        {{ form_widget(form.uploaded_filename, {'attr': {'id': 'uploaded_filename'}}) }}
                        <!-- Nom de l'ISO -->
                        <div class="mb-4">
                            <div class="form-floating">
                                {{ form_label(form.name, null, {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.name, {'attr': {'class': 'form-control', 'placeholder': 'ISO name'|trans}}) }}
                            </div>
                            {{ form_errors(form.name) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'Enter a descriptive name for your ISO file'|trans }}
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-floating">
                                <label class="form-label fw-bold">{{ 'Architecture'|trans }}</label>
                                {{ form_widget(form.arch, {'attr': {'class': 'form-control', 'placeholder': 'Architecture'|trans}}) }}
                            </div>
                            {{ form_errors(form.arch) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'Select the architecture for which this ISO can be used'|trans }}
                            </div>
                        </div>

                        <!-- Sélecteur de type de source -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">{{ 'File Source Type'|trans }}</label>
                            <div class="row g-3 mt-1">
                                <div class="col-sm-4">
                                    <div class="card file-source-card" data-source-type="upload">
                                        <div class="card-body text-center p-3">
                                            <div class="mb-2">
                                                <i class="fa fa-upload fa-2x text-primary"></i>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" 
                                                    class="form-check-input file-source-radio" 
                                                    name="iso[fileSourceType]" 
                                                    value="upload" 
                                                    id="source-upload"
                                                    {% if form.fileSourceType.vars.value == 'upload' %}checked="checked"{% endif %}
                                                >
                                                <label class="form-check-label fw-semibold" for="source-upload">{{ 'Upload File'|trans }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="card file-source-card" data-source-type="url">
                                        <div class="card-body text-center p-3">
                                            <div class="mb-2">
                                                <i class="fa fa-link fa-2x text-success"></i>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" 
                                                    class="form-check-input file-source-radio" 
                                                    name="iso[fileSourceType]" 
                                                    value="url" 
                                                    id="source-url"
                                                    {% if form.fileSourceType.vars.value == 'url' %}checked="checked"{% endif %}
                                                >
                                                <label class="form-check-label fw-semibold" for="source-url">{{ 'URL'|trans }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="card file-source-card" data-source-type="filename">
                                        <div class="card-body text-center p-3">
                                            <div class="mb-2">
                                                <i class="fa fa-file-alt fa-2x text-warning"></i>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" 
                                                    class="form-check-input file-source-radio" 
                                                    name="iso[fileSourceType]" 
                                                    value="filename" 
                                                    id="source-filename"
                                                    {% if form.fileSourceType.vars.value == 'filename' %}checked="checked"{% endif %}
                                                >
                                                <label class="form-check-label fw-semibold" for="source-filename">{{ 'Filename Only'|trans }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Zone d'upload de fichier -->
                        <div class="mb-4 file-upload-block" {% if form.fileSourceType.vars.value != 'upload' %}style="display:none;"{% endif %}>
                            <div class="upload-zone border border-dashed border-2 rounded p-4 text-center position-relative">
                                <div class="upload-content" id="upload-content">
                                    <i class="fa fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5 class="mb-2">{{ 'Upload ISO File'|trans }}</h5>
                                    <p class="text-muted mb-3">{{ 'Drag and drop your ISO file here or click to browse'|trans }}</p>
                                    <input type="file" id="file-input" class="form-control file-input position-absolute w-100 h-100 opacity-0" style="top: 0; left: 0; cursor: pointer;" accept=".iso">
                                    <button type="button" class="btn btn-outline-primary" id="browse-button">
                                        <i class="fa fa-folder-open me-1"></i>{{ 'Browse Files'|trans }}
                                    </button>
                                </div>
                                
                                <!-- Zone d'affichage du fichier sélectionné -->
                                <div class="file-selected d-none" id="file-selected">
                                    <div class="alert alert-info d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-file me-2"></i>
                                            <div>
                                                <div class="file-name fw-semibold"></div>
                                                <small class="file-size text-muted"></small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-sm btn-primary" id="upload-button">
                                                <i class="fa fa-upload me-1"></i>{{ 'Upload'|trans }}
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-file">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Zone d'affichage du fichier uploadé -->
                                <div class="file-uploaded d-none" id="file-uploaded">
                                    <div class="alert alert-success d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-check-circle me-2"></i>
                                            <div>
                                                <div class="uploaded-file-name fw-semibold"></div>
                                                <small class="uploaded-file-size text-muted"></small>
                                                <div><small class="text-success">{{ 'File uploaded successfully'|trans }}</small></div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="remove-uploaded-file">
                                            <i class="fa fa-trash me-1"></i>{{ 'Remove'|trans }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {{ form_errors(form.uploadedFile) }}
                            <div class="form-text">
                                <i class="fa fa-exclamation-triangle text-warning"></i> 
                                {{ "Maximum file size configured on your system : " ~ sizeLimit ~ ". Accepted formats: .iso"|trans }}
                            </div>
                        </div>

                        <!-- Zone URL -->
                        <div class="mb-4 url-block" {% if form.fileSourceType.vars.value != 'url' %}style="display:none;"{% endif %}>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">
                                    <i class="fa fa-link text-success"></i>
                                </span>
                                {{ form_widget(form.Filename_url, {'attr': {'class': 'form-control', 'placeholder': 'https://example.com/file.iso'}}) }}
                                <button class="btn btn-outline-secondary" type="button" id="validateUrl">
                                    <i class="fa fa-check"></i> {{ 'Validate'|trans }}
                                </button>
                            </div>
                            {{ form_errors(form.Filename_url) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> 
                                {{ 'Enter the direct URL to download the ISO file'|trans }}
                            </div>
                        </div>

                        <!-- Zone nom de fichier seulement -->
                        <div class="mb-4 filename-only-block" {% if form.fileSourceType.vars.value != 'filename' %}style="display:none;"{% endif %}>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">
                                    <i class="fa fa-file-alt text-warning"></i>
                                </span>
                                {{ form_widget(form.Filename, {'attr': {'class': 'form-control', 'id': 'iso-filename-input', 'placeholder': 'file.iso'|trans}}) }}
                            </div>
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> 
                                {{ 'Enter only the filename (file should already exist on the server)'|trans }}
                            </div>
                        </div>

                        <!-- Progress bar (cachée par défaut) -->
                        <div class="mb-4 upload-progress d-none" id="upload-progress">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">{{ 'Upload Progress'|trans }}</span>
                                <span class="progress-percentage">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" 
                                     aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <!-- Champ Description -->
                        <div class="mb-4">
                            <div class="form-floating">
                                <label class="form-label fw-bold">{{ 'Description'|trans }}</label>
                                {{ form_widget(form.description, {'attr': {'class': 'form-control', 'placeholder': 'Description'|trans}}) }}
                            </div>
                            {{ form_errors(form.description) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'You can provide an optional description for this ISO'|trans }}
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex gap-3 justify-content-end mt-4 pt-3 border-top">
                            <a href="{{ path('app_iso_index') }}" class="btn btn-danger btn-lg px-3">
                                <i class="fa fa-times me-1"></i> {{ 'Cancel'|trans }}
                            </a>
                            {{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary btn-lg px-4', 'id': 'submit-button'}}) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .file-source-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #dee2e6;
        }
           
        .file-source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .file-source-card.active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .upload-zone {
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone:hover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        
        .upload-zone.drag-over {
            border-color: #198754;
            background-color: #f8fff9;
            transform: scale(1.02);
        }
        
        .file-input:hover + .upload-content,
        .file-input:focus + .upload-content {
            color: #0d6efd;
        }
        
        .progress {
            height: 12px;
        }
        
        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label {
            opacity: 0.65;
            transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
        }

        [theme="dark"] .file-source-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #252525ff;
        }
           
        [theme="dark"] .file-source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        [theme="dark"] .file-source-card.active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        [theme="dark"] .upload-zone {
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        [theme="dark"] .upload-zone:hover {
            border-color: #0d6efd;
            background-color: #1a1d29;
        }
        
        [theme="dark"] .upload-zone.drag-over {
            border-color: #198754;
            background-color: #1a2e1f;
            transform: scale(1.02);
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('iso-form-handler') }}
{% endblock %}