{% extends 'dashboard.base.html.twig' %}

{% block breadcrumbs %}
    {% set breadcrumbs = breadcrumbs|merge({ 'ISO': path('app_iso_index'), 'Nouveau': path('app_iso_new') }) %}
    {{ parent() }}
{% endblock %}

{% block sidebar %}
    {% set category = 'app_iso_index' %}
    {{ parent() }}
{% endblock %}

{% block wrapper %}
    <div class="content-title">
        <div class="content-title-infos">
            <h1>{{ 'New ISO'|trans }}</h1>
            <p class="text-muted">{{ 'Create a new ISO file entry by uploading a file or providing a URL'|trans }}</p>
        </div>
        <div class="content-title-actions">
            <a href="{{ path('app_iso_index') }}" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i> {{ 'Back'|trans }}
            </a>
        </div>
    </div>

    <div class="content-body">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fa fa-compact-disc me-2"></i> {{ 'ISO Configuration'|trans }}
                        </h5>
                    </div>
                    <div class="card-body">
                        {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': true}}) }}
                        
                        <!-- Champ caché pour stocker le nom du fichier uploadé -->
                        <input type="hidden" name="uploaded_filename" id="uploaded_filename" value="">
                        
                        <!-- Nom de l'ISO -->
                        <div class="mb-4">
                            <div class="form-floating">
                                {{ form_label(form.name, null, {'label_attr': {'class': 'form-label'}}) }}
                                {{ form_widget(form.name, {'attr': {'class': 'form-control', 'placeholder': 'ISO name'|trans}}) }}
                            </div>
                            {{ form_errors(form.name) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'Enter a descriptive name for your ISO file'|trans }}
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-floating">
                                <label class="form-label fw-bold">{{ 'Architecture'|trans }}</label>
                                {{ form_widget(form.arch, {'attr': {'class': 'form-control', 'placeholder': 'Architecture'|trans}}) }}
                                
                            </div>
                            {{ form_errors(form.arch) }}
                            
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'Select the architecture for which this ISO can be used'|trans }}
                            </div>
                        </div>

                        <!-- Sélecteur de type de source -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">{{ 'File Source Type'|trans }}</label>
                            <div class="row g-3 mt-1">
                                {% for choice in form.fileSourceType %}
                                    <div class="col-sm-6">
                                        <div class="card file-source-card" 
                                             data-source-type="{{ choice.vars.value }}">
                                            <div class="card-body text-center p-3">
                                                <div class="mb-2">
                                                    {% if choice.vars.value == 'upload' %}
                                                        <i class="fa fa-upload fa-2x text-primary"></i>
                                                    {% else %}
                                                        <i class="fa fa-link fa-2x text-success"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="form-check">
                                                    {{ form_widget(choice, {'attr': {'class': 'form-check-input file-source-radio'}}) }}
                                                    {{ form_label(choice, null, {'label_attr': {'class': 'form-check-label fw-semibold'}}) }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {{ form_errors(form.fileSourceType) }}
                        </div>

                        <!-- Zone d'upload de fichier -->
                        <div class="mb-4 file-upload-block" {% if form.fileSourceType.vars.value != 'upload' %}style="display:none;"{% endif %}>
                            <div class="upload-zone border border-dashed border-2 rounded p-4 text-center position-relative">
                                <div class="upload-content" id="upload-content">
                                    <i class="fa fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5 class="mb-2">{{ 'Upload ISO File'|trans }}</h5>
                                    <p class="text-muted mb-3">{{ 'Drag and drop your ISO file here or click to browse'|trans }}</p>
                                    <input type="file" id="file-input" class="form-control file-input position-absolute w-100 h-100 opacity-0" style="top: 0; left: 0; cursor: pointer;" accept=".iso">
                                    <button type="button" class="btn btn-outline-primary" id="browse-button">
                                        <i class="fa fa-folder-open me-1"></i>{{ 'Browse Files'|trans }}
                                    </button>
                                </div>
                                
                                <!-- Zone d'affichage du fichier sélectionné -->
                                <div class="file-selected d-none" id="file-selected">
                                    <div class="alert alert-info d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-file me-2"></i>
                                            <div>
                                                <div class="file-name fw-semibold"></div>
                                                <small class="file-size text-muted"></small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-sm btn-primary" id="upload-button">
                                                <i class="fa fa-upload me-1"></i>{{ 'Upload'|trans }}
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-file">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Zone d'affichage du fichier uploadé -->
                                <div class="file-uploaded d-none" id="file-uploaded">
                                    <div class="alert alert-success d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-check-circle me-2"></i>
                                            <div>
                                                <div class="uploaded-file-name fw-semibold"></div>
                                                <small class="uploaded-file-size text-muted"></small>
                                                <div><small class="text-success">{{ 'File uploaded successfully'|trans }}</small></div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="remove-uploaded-file">
                                            <i class="fa fa-trash me-1"></i>{{ 'Remove'|trans }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {{ form_errors(form.uploadedFile) }}
                            <div class="form-text">
                                <i class="fa fa-exclamation-triangle text-warning"></i> 
                                {{ "Maximum file size configured on your system : " ~ sizeLimit ~ ". Accepted formats: .iso"|trans }}
                            </div>
                        </div>

                        <!-- Zone URL -->
                        <div class="mb-4 url-block" {% if form.fileSourceType.vars.value != 'url' %}style="display:none;"{% endif %}>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">
                                    <i class="fa fa-link text-success"></i>
                                </span>
                                {{ form_widget(form.Filename_url, {'attr': {'class': 'form-control', 'placeholder': 'https://example.com/file.iso'}}) }}
                                <button class="btn btn-outline-secondary" type="button" id="validateUrl">
                                    <i class="fa fa-check"></i> {{ 'Validate'|trans }}
                                </button>
                            </div>
                            {{ form_errors(form.Filename_url) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> 
                                {{ 'Enter the direct URL to download the ISO file'|trans }}
                            </div>
                        </div>

                        <!-- Progress bar (cachée par défaut) -->
                        <div class="mb-4 upload-progress d-none" id="upload-progress">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">{{ 'Upload Progress'|trans }}</span>
                                <span class="progress-percentage">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" 
                                     aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <!-- Champ Description -->
                        <div class="mb-4">
                            <div class="form-floating">
                                <label class="form-label fw-bold">{{ 'Description'|trans }}</label>
                                {{ form_widget(form.description, {'attr': {'class': 'form-control', 'placeholder': 'Description'|trans}}) }}
                            </div>
                            {{ form_errors(form.description) }}
                            <div class="form-text">
                                <i class="fa fa-info-circle text-info"></i> {{ 'You can provide an optional description for this ISO'|trans }}
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex gap-3 justify-content-end mt-4 pt-3 border-top">
                            <a href="{{ path('app_iso_index') }}" class="btn btn-outline-secondary">
                                <i class="fa fa-times me-1"></i>{{ 'Cancel'|trans }}
                            </a>
                            {{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary btn-lg px-4', 'id': 'submit-button'}}) }}
                        </div>

                       
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .file-source-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #dee2e6;
        }
           
        .file-source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .file-source-card.active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .upload-zone {
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone:hover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        
        .upload-zone.drag-over {
            border-color: #198754;
            background-color: #f8fff9;
            transform: scale(1.02);
        }
        
        .file-input:hover + .upload-content,
        .file-input:focus + .upload-content {
            color: #0d6efd;
        }
        
        .progress {
            height: 12px;
        }
        
        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label {
            opacity: 0.65;
            transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
        }

        [theme="dark"] .file-source-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #252525ff;
        }
           
        [theme="dark"] .file-source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        [theme="dark"] .file-source-card.active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        [theme="dark"] .upload-zone {
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        [theme="dark"] .upload-zone:hover {
            border-color: #0d6efd;
            background-color: #1a1d29;
        }
        
        [theme="dark"] .upload-zone.drag-over {
            border-color: #198754;
            background-color: #1a2e1f;
            transform: scale(1.02);
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('build/Iso/upload.js') }}"></script>
    <script>
    
        document.addEventListener('DOMContentLoaded', function () {
            const radios = document.querySelectorAll('.file-source-radio');
            const uploadBlock = document.querySelector('.file-upload-block');
            const urlBlock = document.querySelector('.url-block');
            const fileInput = document.getElementById('file-input');
            const uploadZone = document.querySelector('.upload-zone');
            const uploadContent = document.getElementById('upload-content');
            const fileSelected = document.getElementById('file-selected');
            const fileUploaded = document.getElementById('file-uploaded');
            const uploadButton = document.getElementById('upload-button');
            const cancelFileButton = document.getElementById('cancel-file');
            const removeUploadedFileButton = document.getElementById('remove-uploaded-file');
            const browseButton = document.getElementById('browse-button');
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.querySelector('.progress-bar');
            const progressPercentage = document.querySelector('.progress-percentage');
            const form = document.querySelector('form');
            const submitButton = document.getElementById('submit-button');
            const uploadedFilenameInput = document.getElementById('uploaded_filename');

            let selectedFile = null;
            let uploadedFile = null;

            // Gestion des cartes de sélection
            function updateSourceCards() {
                document.querySelectorAll('.file-source-card').forEach(card => {
                    const radio = card.querySelector('input[type="radio"]');
                    card.classList.toggle('active', radio.checked);
                });
            }

            // Gestion du changement de source
            radios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'upload') {
                        uploadBlock.style.display = '';
                        urlBlock.style.display = 'none';
                    } else {
                        uploadBlock.style.display = 'none';
                        urlBlock.style.display = '';
                        // Reset upload state when switching to URL
                        resetUploadState();
                    }
                    updateSourceCards();
                });
            });

            // Gestion du clic sur les cartes
            document.querySelectorAll('.file-source-card').forEach(card => {
                card.addEventListener('click', function () {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                });
            });

            // Clic sur le bouton Browse
            browseButton.addEventListener('click', function() {
                fileInput.click();
            });

            // Gestion du drag & drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadZone.classList.add('drag-over');
            }

            function unhighlight(e) {
                uploadZone.classList.remove('drag-over');
            }

            uploadZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            }

            // Sélection de fichier
            fileInput.addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            function handleFileSelection(file) {
                selectedFile = file;
                displaySelectedFile(file);
                showFileSelected();
            }

            function displaySelectedFile(file) {
                const fileName = fileSelected.querySelector('.file-name');
                const fileSize = fileSelected.querySelector('.file-size');
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
            }

            function showFileSelected() {
                uploadContent.classList.add('d-none');
                fileSelected.classList.remove('d-none');
                fileUploaded.classList.add('d-none');
            }

            function showFileUploaded(uploadData) {
                const uploadedFileName = fileUploaded.querySelector('.uploaded-file-name');
                const uploadedFileSize = fileUploaded.querySelector('.uploaded-file-size');
                
                uploadedFileName.textContent = uploadData.originalName;
                uploadedFileSize.textContent = formatFileSize(uploadData.size);
                
                uploadContent.classList.add('d-none');
                fileSelected.classList.add('d-none');
                fileUploaded.classList.remove('d-none');
                
                uploadedFile = uploadData;
                uploadedFilenameInput.value = uploadData.filename;
            }

            function resetUploadState() {
                selectedFile = null;
                uploadedFile = null;
                uploadedFilenameInput.value = '';
                
                uploadContent.classList.remove('d-none');
                fileSelected.classList.add('d-none');
                fileUploaded.classList.add('d-none');
                progressContainer.classList.add('d-none');
                
                // Reset file input
                fileInput.value = '';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Bouton Cancel file
            cancelFileButton.addEventListener('click', function() {
                resetUploadState();
            });

            // Bouton Remove uploaded file
            removeUploadedFileButton.addEventListener('click', function() {
                if (!uploadedFile) return;

                // Supprimer le fichier du serveur
                fetch('{{ path('app_iso_delete_temp_file') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'filename=' + encodeURIComponent(uploadedFile.filename)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resetUploadState();
                    } else {
                        alert('{{ 'Error removing file'|trans }}: ' + (data.error || '{{ 'Unknown error'|trans }}'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{{ 'Network error'|trans }}');
                });
            });

            // Validation du formulaire avant submit
            form.addEventListener('submit', function(e) {
                const fileSourceType = document.querySelector('input[name="iso[fileSourceType]"]:checked').value;
                
                if (fileSourceType === 'upload') {
                    if (!uploadedFile) {
                        e.preventDefault();
                        alert('{{ 'Please upload a file first or switch to URL mode'|trans }}');
                        return false;
                    }
                }
                
                return true;
            });

            // Validation d'URL améliorée
            const validateUrlBtn = document.getElementById('validateUrl');
            const urlInput = document.querySelector('input[name="iso[Filename_url]"]');
            
            if (validateUrlBtn && urlInput) {
                validateUrlBtn.addEventListener('click', function () {
                    const url = urlInput.value.trim();
                    if (!url) {
                        alert('{{ 'Please enter a URL first'|trans }}');
                        return;
                    }

                    // Reset button state
                    validateUrlBtn.classList.remove('btn-outline-success', 'btn-outline-danger');
                    validateUrlBtn.classList.add('btn-outline-secondary');
                    validateUrlBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> {{ 'Validating...'|trans }}';
                    validateUrlBtn.disabled = true;
                    
                    // Faire la validation côté serveur
                    fetch('{{ path('app_iso_validate_url') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'url=' + encodeURIComponent(url)
                    })
                    .then(response => response.json())
                    .then(data => {
                        validateUrlBtn.disabled = false;
                        
                        if (data.success && data.valid) {
                            validateUrlBtn.innerHTML = '<i class="fa fa-check text-success"></i> {{ 'Valid'|trans }}';
                            validateUrlBtn.classList.remove('btn-outline-secondary');
                            validateUrlBtn.classList.add('btn-outline-success');
                            
                            // Afficher les informations du fichier
                            let infoMessage = '{{ 'URL is valid'|trans }}';
                            if (data.fileSize) {
                                infoMessage += ' - {{ 'Size'|trans }}: ' + formatFileSize(data.fileSize);
                            }
                            if (data.fileName) {
                                infoMessage += ' - {{ 'File'|trans }}: ' + data.fileName;
                            }
                            
                            // Créer ou mettre à jour l'alerte d'information
                            showUrlValidationResult(infoMessage, 'success');
                            
                        } else {
                            validateUrlBtn.innerHTML = '<i class="fa fa-times text-danger"></i> {{ 'Invalid'|trans }}';
                            validateUrlBtn.classList.remove('btn-outline-secondary');
                            validateUrlBtn.classList.add('btn-outline-danger');
                            
                            const errorMessage = data.error || '{{ 'Unknown validation error'|trans }}';
                            showUrlValidationResult(errorMessage, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        validateUrlBtn.disabled = false;
                        validateUrlBtn.innerHTML = '<i class="fa fa-times text-danger"></i> {{ 'Error'|trans }}';
                        validateUrlBtn.classList.remove('btn-outline-secondary');
                        validateUrlBtn.classList.add('btn-outline-danger');
                        
                        showUrlValidationResult('{{ 'Network error during validation'|trans }}', 'danger');
                    });
                });

                // Reset validation when URL changes
                urlInput.addEventListener('input', function() {
                    validateUrlBtn.classList.remove('btn-outline-success', 'btn-outline-danger');
                    validateUrlBtn.classList.add('btn-outline-secondary');
                    validateUrlBtn.innerHTML = '<i class="fa fa-check"></i> {{ 'Validate'|trans }}';
                    validateUrlBtn.disabled = false;
                    
                    // Remove any existing validation result
                    const existingAlert = urlBlock.querySelector('.url-validation-result');
                    if (existingAlert) {
                        existingAlert.remove();
                    }
                });
            }

            function showUrlValidationResult(message, type) {
                // Remove existing alert
                const existingAlert = urlBlock.querySelector('.url-validation-result');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Create new alert
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} mt-2 url-validation-result`;
                alertDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                // Add after the input group
                const inputGroup = urlBlock.querySelector('.input-group');
                inputGroup.parentNode.insertBefore(alertDiv, inputGroup.nextSibling);
            }

            function isValidUrl(string) {
                try {
                    new URL(string);
                    return string.toLowerCase().endsWith('.iso') || string.includes('.iso');
                } catch (_) {
                    return false;
                }
            }

            // Initialisation
            updateSourceCards();
        });
    </script>
{% endblock %}