{% extends 'dashboard.base.html.twig' %}

{% block breadcrumbs %}
    {%- set breadcrumbs = breadcrumbs|merge({ 'Instances': path('instances') }) -%}
    {{ parent() }}
{% endblock %}

{% block sidebar %}
    {% set category = 'instances' %}
    {{ parent() }}
{% endblock %}

{% block wrapper %}
    <div class="top-panel">
            <div class="quick-actions">
                {% if is_granted('ROLE_ADMINISTRATOR') %}
                {% endif %}
            </div>
            <input type="hidden" id="instance_page" value={{page}}/>
    </div>

    <div class="labs-panel">
        <h4 class="p-3 border-bottom">Lab instances
        <span data-toggle="tooltip" data-placement="right" title="All laboratories started by you, your groups and members of your groups.">
            {{ svg('question') }} </span></h4>

        {% if is_granted('ROLE_ADMINISTRATOR') or is_granted('ROLE_TEACHER')%}
            {{ form_start(addFilterForm, {"action": path('instances'), "method":"GET"}) }}
                
                {# Barre de recherche UUID #}
                <div style="padding: 12px;">
                <div class="d-flex align-items-center" style="gap: 8px;">
                    {{ form_widget(addFilterForm.searchUuid, {
                        'attr': {
                            'id': 'instance_searchUuid',
                            'style': 'flex: 1;'
                        }
                    }) }}
                    <button type="submit" class="btn btn-sm btn-primary">Search UUID</button>
                </div>
                <small style="color: #6c757d; margin-top: 8px; display: block;">
                    {{ form_label(addFilterForm.searchUuid) }}
                </small>
            </div>

                {# Filtres standards #}
                <div>
                <div><span>Filter by :</span></div>
                <div class="d-flex align-items-center mb-2">
                    <select name="{{ field_name(addFilterForm.filter) }}" id="instance_filter" class="mr-3 instancesFilter form-control"> 
                        {% for label, value in field_choices(addFilterForm.filter) %}
                            <option {% if value == field_value(addFilterForm.filter) %}selected="selected"{% endif %} value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="{{ field_name(addFilterForm.subFilter) }}" id="instance_subFilter" class="mr-3 subFilter form-control"> 
                        {% for label, value in field_choices(addFilterForm.subFilter) %}
                            <option {% if value == field_value(addFilterForm.subFilter) %}selected="selected"{% endif %} value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>

                    <button id="instance_submit" class="btn-success btn" type="submit" name="{{ field_name(addFilterForm.submit) }}">{{ field_label(addFilterForm.submit) }}</button>
                </div>
            </div>

            {{ form_end(addFilterForm) }}
        {% else %}
            <div>
                <input type="hidden" id="instance_filter" value="none"/>
                <input type="hidden" id="instance_subFilter" value="allInstances"/>
                <input type="hidden" id="instance_searchUuid" value=""/>
            </div>
        {% endif %}

       <div class="col">{{ react_component('AllInstancesList', {"props": props})}}</div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ encore_entry_script_tags('app') }}

    {{ parent() }}

    <script>

    document.addEventListener('DOMContentLoaded', function() {
        const filterSelector = document.getElementById('instance_filter');
        const searchUuidInput = document.getElementById('instance_searchUuid');

        if (filterSelector && filterSelector.type !== "hidden") {
            // Vérifier que jQuery et Select2 sont disponibles
            if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
                // Initialiser Select2 sur le subFilter
                jQuery('#instance_subFilter').select2({
                    theme: "bootstrap-5",
                });

                // Écouter les changements du filtre principal
                filterSelector.addEventListener('change', function() {
                    const filterValue = this.value;
                    
                    jQuery.ajax({
                        url: "{{ path('api_list_instances_filter') }}",
                        type: "GET",
                        dataType: "JSON",
                        data: {
                            filter: filterValue
                        },
                        success: function (choices) {
                            const subFilterSelect = document.getElementById('instance_subFilter');
                            
                            // Vider les options existantes
                            subFilterSelect.innerHTML = '';
                            
                            // Ajouter les nouvelles options
                            choices.forEach(function(choice) {
                                const option = document.createElement('option');
                                option.value = choice.uuid;
                                option.textContent = choice.name;
                                subFilterSelect.appendChild(option);
                            });
                            
                            // Réinitialiser Select2
                            jQuery('#instance_subFilter').select2('destroy');
                            jQuery('#instance_subFilter').select2({
                                theme: "bootstrap-5",
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error('Erreur lors du chargement des filtres:', error);
                            console.error('Réponse:', xhr.responseText);
                        }
                    });
                });

                // Validation UUID au changement
                if (searchUuidInput) {
                    searchUuidInput.addEventListener('change', function() {
                        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                        
                        if (this.value && !uuidRegex.test(this.value)) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                        }
                    });
                }
            } else {
                console.error('jQuery ou Select2 non disponible');
            }
        }
    });
        
    </script>
{% endblock %}